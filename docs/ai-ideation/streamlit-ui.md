# Streamlit Trading Console

A lightweight **Streamlit UI** for the Algorithmic Trader platform. It visualizes Screener/Analyzer outputs, previews Strategy bucket allocations by timeslot, runs **dry-run execution**, and surfaces **backtest** results. Designed to work both **locally** and as a **microservice on AWS EKS**.

---

## üéØ Goals
- Give operators a **single pane of glass** for:
  - Top volatile candidates (Screener)
  - Pattern classifications (Analyzer)
  - Bucket allocations by timeslot (Strategy)
  - Paper/dry-run orders and positions (Execution)
  - Backtest performance (QuantConnect Lean)
- Toggle **live vs artifacts** mode (read from providers vs from saved files).
- Minimal auth (env-password) with optional OIDC in EKS.

---

## üß± Architecture
- **Frontend**: Streamlit app (single repo service).
- **Data sources** (configurable):
  1. **Artifacts mode** (default): read latest files from `artifacts/`
     - `artifacts/screener/YYYY-MM-DD/screener.parquet`
     - `artifacts/screener/YYYY-MM-DD/screener_top.jsonl`
     - `artifacts/analyzer/YYYY-MM-DD/analyzer_top.jsonl`
     - `artifacts/backtesting/*`
  2. **Live mode** (feature flag): call provider/adapters and/or internal APIs
     - Screener CLI endpoint (optional FastAPI), Alpaca status endpoints, etc.
- **Deployment**: Dockerized; runs as `ui` service/pod on **AWS EKS** behind an Ingress.

---

## üìÑ Pages & Features

### 1) **Dashboard**
- KPIs: #Candidates, Top ATR% / HV, #By Pattern, Bucket Exposures (target vs planned)
- Market clock & session phase (time slot badge)
- P/L tiles (paper only), rolling equity curve (from backtest or live if available)
- Alerts panel (e.g., missing artifacts, upcoming earnings flags)

### 2) **Screener**
- Interactive table (AgGrid or Streamlit DataFrame) with filters:
  - Price, Avg $Vol (20d), ATR%, HV(10/20), Range% Day, Gap%
  - Sector/Industry filters, sort by ATR% (default)
- **Symbol drill-down**:
  - Plotly candlestick + volume
  - Overlays: VWAP, SMA20/50/200, RSI panel
  - Add to **Watchlist** (session) or **Strategy Preview** (allocation sandbox)

### 3) **Analyzer**
- Pattern summary: bar chart (# by pattern, intraday vs multi-day)
- Table with pattern label, confidence (if applicable), suggested playbook
- Quick actions:
  - ‚ÄúSend to Strategy Preview‚Äù (selected rows)
  - Export current selection as JSONL

### 4) **Strategy**
- **Bucket definitions** (read from `config/strategy.yaml`) with editable sliders (session-scoped):
  - Bucket A‚ÄìE weights, per-bucket constraints (max per position, price floors)
- **Time slot rules** (9:30‚Äì10:30, 10:30‚Äì13:30, 13:30‚Äì15:00, 15:00‚Äì16:00)
- **Allocation preview**: given a watchlist/pattern set, show proposed allocation and position sizes
- Export **preview plan** to `artifacts/ui/YYYY-MM-DD/strategy_preview.json`

### 5) **Execution (Dry-Run / Paper)**
- **Mode switch**: DRY_RUN (no orders), PAPER (Alpaca paper), LIVE (hidden unless explicitly enabled)
- Alpaca connection status (keys present? account mode? buying power?)
- Current positions & orders (read-only in DRY_RUN)
- **Preview orders** generated by Strategy -> ‚ÄúSimulate/Submit‚Äù (respects DRY_RUN)
- Tag every intent with `{bucket_id, pattern_id, timeslot}`

### 6) **Backtests**
- Load Lean outputs (CSV/JSON) under `artifacts/backtesting/`
- Equity curve, monthly heatmap, drawdown, Sharpe, win-rate, avg R, per-bucket metrics
- Compare baseline (SMA/RSI) vs strategy (A‚ÄìE buckets)

### 7) **Settings**
- Mode: **Artifacts** or **Live**
- Paths: artifacts root, date override
- Feature flags: `FEATURE_TV`, `FEATURE_LIVE_PROVIDERS`, `ENABLE_PAPER_TRADE`
- Auth: env password check
- Theme: light/dark, number formatting

---

## üîå Data Contracts

### Screener (parquet)
- Columns (subset): `symbol, name, sector, industry, last, prev_close, open, high, low, volume, avg_dollar_volume_20d, atr_14, atrp_14, hv_10, hv_20, range_pct_day, gap_pct, sma_20, sma_50, sma_200, rsi_14, asof, provider`

### Screener Top (jsonl)
- Records: `{ symbol, volatility: {atrp_14, hv_20, range_pct_day}, liquidity: {avg_dollar_volume_20d}, technicals: {...}, flags: {...}, asof }`

### Analyzer Top (jsonl)
- Records: `{ symbol, pattern_intraday, pattern_multiday, confidence, hints: {bucket_suggestion, timeslot_suggestion}, asof }`

### Strategy Preview (json)
- `{ total_equity, timeslot, allocations: [{bucket_id, target_weight, symbols: [{symbol, size, rationale}]}] }`

---

## üß∞ Tech & Libraries
- **Streamlit** (app shell, multipage, session_state)
- **Plotly** (charts: candlestick, volume, distribution)
- **Pandas / PyArrow** (parquet ingestion)
- **pydantic** (validate loaded JSON/JSONL)
- Optional: **st-aggrid** for richer tables (or stick to native Streamlit)

---

## üß™ Testing
- Data layer tests: ensure parquet/JSONL schemas load & validate
- Snapshot tests for allocation preview given a fixed input set
- Smoke test: run in Artifacts mode w/ sample files

---

## üîê Auth
- Minimal: `UI_PASSWORD` env var; gate the app via a login form
- EKS option: OIDC/OAuth2 via Ingress proxy (out of scope for MVP)

---

## ‚öôÔ∏è Config
`.env.example` additions:
UI_MODE=artifacts            # artifacts | live
UI_PASSWORD=changeme         # simple password gate
ARTIFACTS_ROOT=artifacts
FEATURE_LIVE_PROVIDERS=false
FEATURE_TV=false
ENABLE_PAPER_TRADE=false     # UI shows paper trading controls when true
`config/ui.yaml` (optional):
```yaml
refresh_seconds: 30
default_timeslot: "09:30-10:30"
charts:
  show_vwap: true
  show_sma: [20, 50, 200]
```


## Local run 
```bash
poetry run streamlit run ui/app.py
# or
make ui.run
```

## Dockerfile
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY pyproject.toml poetry.lock* /app/
RUN pip install --no-cache-dir poetry && poetry install --no-interaction --no-ansi
COPY ui /app/ui
COPY packages /app/packages
ENV PORT=8501
EXPOSE 8501
CMD ["poetry", "run", "streamlit", "run", "ui/app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

‚ò∏Ô∏è EKS Deployment

K8s (or Helm) manifests for ui:
	‚Ä¢	Deployment: 1‚Äì3 replicas, UI_MODE=artifacts
	‚Ä¢	Service: ClusterIP
	‚Ä¢	Ingress: route / ‚Üí ui service
	‚Ä¢	HPA (optional): CPU/Memory targets
	‚Ä¢	ConfigMap: config/ui.yaml
	‚Ä¢	Secret: UI_PASSWORD

Example Make targets:


```bash
make ui.docker.build
make ui.docker.push
make ui.deploy
```

üß≠ Page Routing (recommended)
	‚Ä¢	ui/app.py ‚Üí Dashboard
	‚Ä¢	ui/pages/1_Screener.py
	‚Ä¢	ui/pages/2_Analyzer.py
	‚Ä¢	ui/pages/3_Strategy.py
	‚Ä¢	ui/pages/4_Execution.py
	‚Ä¢	ui/pages/5_Backtests.py
	‚Ä¢	ui/pages/6_Settings.py


üìù UX Notes
	‚Ä¢	Always display current timeslot badge
	‚Ä¢	Color semantics: green (trend-up), red (trend-down), gray (range)
	‚Ä¢	Tooltips on indicators (ATR%, HV) and bucket rules
	‚Ä¢	‚ÄúCopy to clipboard‚Äù actions for symbol lists