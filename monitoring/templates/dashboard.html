<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Platform Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .status-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .status-card .unit {
            font-size: 0.9rem;
            color: #666;
            margin-left: 0.25rem;
        }

        .health-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .health-healthy {
            background-color: #d4edda;
            color: #155724;
        }

        .health-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .health-degraded {
            background-color: #f8d7da;
            color: #721c24;
        }

        .health-critical {
            background-color: #f5c6cb;
            color: #721c24;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: #333;
            font-weight: 500;
        }

        .alerts-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alerts-header h3 {
            color: #333;
            font-weight: 500;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .alert-item {
            border-left: 4px solid #ddd;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f9f9f9;
            border-radius: 0 4px 4px 0;
        }

        .alert-critical {
            border-left-color: #dc3545;
            background-color: #f8f9fa;
        }

        .alert-error {
            border-left-color: #fd7e14;
            background-color: #f8f9fa;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background-color: #f8f9fa;
        }

        .alert-info {
            border-left-color: #17a2b8;
            background-color: #f8f9fa;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .alert-title {
            font-weight: 600;
            color: #333;
        }

        .alert-level {
            padding: 0.125rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-level.critical {
            background-color: #dc3545;
            color: white;
        }

        .alert-level.error {
            background-color: #fd7e14;
            color: white;
        }

        .alert-level.warning {
            background-color: #ffc107;
            color: #333;
        }

        .alert-level.info {
            background-color: #17a2b8;
            color: white;
        }

        .alert-message {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .alert-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #999;
        }

        .alert-timestamp {
            font-family: monospace;
        }

        .resolve-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .resolve-btn:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                padding: 1rem;
            }
            
            .status-overview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading Platform Dashboard</h1>
    </div>

    <div class="connection-status" id="connectionStatus">
        <span id="connectionText">Connecting...</span>
    </div>

    <div class="dashboard">
        <div class="status-overview" id="statusOverview">
            <div class="loading">Loading system status...</div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>System Metrics</h3>
                <canvas id="systemChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
                <h3>Trading Metrics</h3>
                <canvas id="tradingChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="alerts-section">
            <div class="alerts-header">
                <h3>Active Alerts</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-level="all">All</button>
                    <button class="filter-btn" data-level="critical">Critical</button>
                    <button class="filter-btn" data-level="error">Error</button>
                    <button class="filter-btn" data-level="warning">Warning</button>
                    <button class="filter-btn" data-level="info">Info</button>
                </div>
            </div>
            <div id="alertsList">
                <div class="loading">Loading alerts...</div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        let socket = null;
        let reconnectInterval = 5000;
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadInitialData();
            setupEventListeners();
            setupCharts();
        });

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                setTimeout(initWebSocket, reconnectInterval);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = 'Disconnected';
            }
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'status_update':
                    updateStatusOverview(message.data);
                    break;
                case 'new_alert':
                    addNewAlert(message.data);
                    break;
                case 'alert_update':
                    handleAlertUpdate(message.data);
                    break;
            }
        }

        async function loadInitialData() {
            try {
                // Load system status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                updateStatusOverview(statusData);

                // Load alerts
                const alertsResponse = await fetch('/api/alerts');
                const alertsData = await alertsResponse.json();
                updateAlertsList(alertsData.alerts);

                // Load metrics history for charts
                const metricsResponse = await fetch('/api/metrics/history?hours=12');
                const metricsData = await metricsResponse.json();
                updateCharts(metricsData);

            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }

        function updateStatusOverview(status) {
            const overview = document.getElementById('statusOverview');
            
            const healthClass = `health-${status.health_status.toLowerCase()}`;
            
            overview.innerHTML = `
                <div class="status-card">
                    <h3>System Health</h3>
                    <div class="value">
                        <span class="health-status ${healthClass}">${status.health_status}</span>
                    </div>
                </div>
                <div class="status-card">
                    <h3>CPU Usage</h3>
                    <div class="value">${status.system_metrics.cpu_usage.toFixed(1)}<span class="unit">%</span></div>
                </div>
                <div class="status-card">
                    <h3>Memory Usage</h3>
                    <div class="value">${status.system_metrics.memory_usage.toFixed(1)}<span class="unit">%</span></div>
                </div>
                <div class="status-card">
                    <h3>Daily P&L</h3>
                    <div class="value">$${status.trading_metrics.daily_pnl.toFixed(2)}</div>
                </div>
                <div class="status-card">
                    <h3>Active Positions</h3>
                    <div class="value">${status.trading_metrics.active_positions}</div>
                </div>
                <div class="status-card">
                    <h3>Total Trades</h3>
                    <div class="value">${status.trading_metrics.total_trades}</div>
                </div>
                <div class="status-card">
                    <h3>Active Alerts</h3>
                    <div class="value">${status.alerts.total_active}</div>
                </div>
                <div class="status-card">
                    <h3>Uptime</h3>
                    <div class="value">${status.uptime_hours.toFixed(1)}<span class="unit">hrs</span></div>
                </div>
            `;
        }

        function updateAlertsList(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No active alerts</div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.level}" data-alert-id="${alert.id}" data-level="${alert.level}">
                    <div class="alert-header">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-level ${alert.level}">${alert.level}</div>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-meta">
                        <span>${alert.component} • ${alert.type}</span>
                        <div>
                            <span class="alert-timestamp">${formatTimestamp(alert.timestamp)}</span>
                            <button class="resolve-btn" onclick="resolveAlert('${alert.id}')">Resolve</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addNewAlert(alert) {
            // Add to the beginning of the alerts list
            const alertsList = document.getElementById('alertsList');
            const newAlertHtml = `
                <div class="alert-item alert-${alert.level}" data-alert-id="${alert.id}" data-level="${alert.level}">
                    <div class="alert-header">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-level ${alert.level}">${alert.level}</div>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-meta">
                        <span>${alert.component} • ${alert.type}</span>
                        <div>
                            <span class="alert-timestamp">${formatTimestamp(alert.timestamp)}</span>
                            <button class="resolve-btn" onclick="resolveAlert('${alert.id}')">Resolve</button>
                        </div>
                    </div>
                </div>
            `;
            
            alertsList.insertAdjacentHTML('afterbegin', newAlertHtml);
        }

        function handleAlertUpdate(update) {
            if (update.action === 'resolved') {
                const alertElement = document.querySelector(`[data-alert-id="${update.alert_id}"]`);
                if (alertElement) {
                    alertElement.remove();
                }
            }
        }

        async function resolveAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/resolve`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Alert will be removed via WebSocket message
                    console.log(`Alert ${alertId} resolved`);
                } else {
                    console.error('Failed to resolve alert');
                }
            } catch (error) {
                console.error('Error resolving alert:', error);
            }
        }

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filter alerts
                    const level = this.dataset.level;
                    filterAlerts(level);
                });
            });
        }

        function filterAlerts(level) {
            const alerts = document.querySelectorAll('.alert-item');
            
            alerts.forEach(alert => {
                if (level === 'all' || alert.dataset.level === level) {
                    alert.style.display = 'block';
                } else {
                    alert.style.display = 'none';
                }
            });
        }

        function setupCharts() {
            // System metrics chart
            const systemCtx = document.getElementById('systemChart').getContext('2d');
            charts.system = new Chart(systemCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU Usage (%)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Memory Usage (%)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Trading metrics chart
            const tradingCtx = document.getElementById('tradingChart').getContext('2d');
            charts.trading = new Chart(tradingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Daily P&L ($)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Active Positions',
                            data: [],
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateCharts(metricsData) {
            // Update system chart
            if (charts.system && metricsData.timestamps) {
                const labels = metricsData.timestamps.map(ts => new Date(ts).toLocaleTimeString());
                
                charts.system.data.labels = labels;
                charts.system.data.datasets[0].data = metricsData.cpu_usage;
                charts.system.data.datasets[1].data = metricsData.memory_usage;
                charts.system.update();
            }

            // Update trading chart
            if (charts.trading && metricsData.timestamps) {
                const labels = metricsData.timestamps.map(ts => new Date(ts).toLocaleTimeString());
                
                charts.trading.data.labels = labels;
                charts.trading.data.datasets[0].data = metricsData.daily_pnl;
                charts.trading.data.datasets[1].data = metricsData.active_positions;
                charts.trading.update();
            }
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Refresh data periodically
        setInterval(async () => {
            try {
                const metricsResponse = await fetch('/api/metrics/history?hours=12');
                const metricsData = await metricsResponse.json();
                updateCharts(metricsData);
            } catch (error) {
                console.error('Failed to refresh chart data:', error);
            }
        }, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>
